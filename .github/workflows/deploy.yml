name: Build & Deploy to NAS (self-hosted)
#testing cache
on:
  push:
    branches: [ main, feature/rsync ]

concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Restore Next.js cache
        id: restore_next_cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: next-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json', 'next.config.*', 'tsconfig.json', 'app/**', 'pages/**', 'src/**') }}
          restore-keys: |
            next-cache-${{ runner.os }}-

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Build & export static site
        env:
          NEXT_PUBLIC_NOTES_API_URL: ${{ secrets.NEXT_PUBLIC_NOTES_API_URL }}
        run: |
          npm run build
          npm run export
          
      - name: Verify static export exists
        run: |
          if [ ! -d "./out" ] || [ -z "$(ls -A ./out)" ]; then
            echo "::error ::Static export ./out is missing or empty. Did you set output: 'export' or run next export?"
            exit 1
          fi

      - name: Save Next.js cache
        if: steps.restore_next_cache.outputs.cache-hit != 'true' && always()
        uses: actions/cache/save@v4
        with:
          path: .next/cache
          key: next-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json', 'next.config.*', 'tsconfig.json', 'app/**', 'pages/**', 'src/**') }}

      - name: Deploy static export to NAS nginx site dir
        run: |
          echo "Validating rsync availability..."
          rsync --version | head -n 1

          TARGET_SITE="/volume2/docker/personal-website/site"
          echo "Checking that ${TARGET_SITE} exists..."
          if [ ! -d "${TARGET_SITE}" ]; then
            echo "::warning ::${TARGET_SITE} not found; creating it now."
            mkdir -p "${TARGET_SITE}"
          fi
          if [ ! -d "${TARGET_SITE}" ]; then
            echo "::error ::Unable to create ${TARGET_SITE}."
            exit 1
          fi

          echo "Checking write permissions for $(whoami) on ${TARGET_SITE}..."
          if [ ! -w "${TARGET_SITE}" ]; then
            echo "::error ::The workflow user lacks write permissions for ${TARGET_SITE}."
            exit 1
          fi

          echo "Confirming nginx container mount source..."
          NGINX_MOUNT=$(docker container inspect portfolio-web --format '{{range .Mounts}}{{if eq .Destination "/usr/share/nginx/html"}}{{.Source}}{{end}}{{end}}' 2>/dev/null || true)
          if [ -z "${NGINX_MOUNT}" ]; then
            echo "::warning ::Unable to inspect portfolio-web mount; is the container running?"
          elif [[ "${NGINX_MOUNT}" != *"${TARGET_SITE}"* ]]; then
            echo "::warning ::portfolio-web does not appear to mount ${TARGET_SITE} to /usr/share/nginx/html (reported: ${NGINX_MOUNT})."
          fi

          RSYNC_OPTS=(
            -a
            --delete
            --chmod=D755,F644
            --no-owner
            --no-group
            --no-perms
            --mkpath
            --omit-dir-times
            --exclude=.git/
            --exclude=node_modules/
          )

          TARGET_SITE_STAGING="${TARGET_SITE}.staging"
          TARGET_SITE_PREVIOUS="${TARGET_SITE}.previous"

          echo "Syncing static export to ${TARGET_SITE_STAGING} with rsync..."
          rsync "${RSYNC_OPTS[@]}" ./out/ "${TARGET_SITE_STAGING}/"

          echo "Performing atomic swap..."
          # 1. Remove old previous backup if it exists
          if [ -d "${TARGET_SITE_PREVIOUS}" ]; then
            echo "Removing old backup ${TARGET_SITE_PREVIOUS}..."
            rm -rf "${TARGET_SITE_PREVIOUS}"
          fi

          # 2. Move current live site to previous (backup)
          if [ -d "${TARGET_SITE}" ]; then
            echo "Backing up current site to ${TARGET_SITE_PREVIOUS}..."
            mv "${TARGET_SITE}" "${TARGET_SITE_PREVIOUS}"
          fi

          # 3. Move staging to live
          echo "Promoting staging to live..."
          mv "${TARGET_SITE_STAGING}" "${TARGET_SITE}"
          
          echo "Atomic deploy complete. Previous version kept at ${TARGET_SITE_PREVIOUS}"

      - name: Normalize permissions (static site)
        run: |
          TARGET_SITE="/volume2/docker/personal-website/site"

          # Drop ACLs so nginx can read everything (ignore errors if ACLs absent)
          setfacl -bR "${TARGET_SITE}" || true

          # Enforce 755 on dirs and 644 on files, including unchanged artifacts
          find "${TARGET_SITE}" -type d -print0 | xargs -0 chmod 755
          find "${TARGET_SITE}" -type f -print0 | xargs -0 chmod 644

      - name: Sync notes API source
        run: |
          TARGET_NOTES="/volume2/docker/personal-website/notes-api"
          TARGET_PARENT=$(dirname "${TARGET_NOTES}")

          echo "Ensuring parent directory ${TARGET_PARENT} is writable..."
          if [ ! -d "${TARGET_PARENT}" ]; then
            echo "::warning ::Parent directory ${TARGET_PARENT} not found; creating it now."
            mkdir -p "${TARGET_PARENT}"
          fi
          if [ ! -d "${TARGET_PARENT}" ]; then
            echo "::error ::Unable to create ${TARGET_PARENT}."
            exit 1
          fi
          if [ ! -w "${TARGET_PARENT}" ]; then
            echo "::error ::The workflow user cannot write to ${TARGET_PARENT}."
            exit 1
          fi

          RSYNC_OPTS=(
            -a
            --delete
            --chmod=D755,F644
            --no-owner
            --no-group
            --no-perms
            --mkpath
            --omit-dir-times
            --exclude=.git/
            --exclude=node_modules/
          )

          echo "Syncing notes API sources to ${TARGET_NOTES} with rsync..."
          rsync "${RSYNC_OPTS[@]}" ./notes-api/ "${TARGET_NOTES}/"

      - name: Rebuild notes API service
        run: |
          docker compose -f /volume2/docker/personal-website/docker-compose.yml up -d --build notes-api
